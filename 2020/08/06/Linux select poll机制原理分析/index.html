<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zn-ch">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-simple.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux,">










<meta name="description" content="概述Linux系统在访问设备的时候，存在以下几种IO模型：  Blocking IO Model，阻塞IO模型； Nonblocking I/O Model，非阻塞IO模型； I/O Multiplexing Model，IO多路复用模型; Signal Driven I/O Model，信号驱动IO模型； Asynchronous I/O Model，异步IO模型；  今天我们来分析下IO多路复">
<meta name="keywords" content="Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux selectpoll机制原理分析">
<meta property="og:url" content="http://yoursite.com/2020/08/06/Linux select poll机制原理分析/index.html">
<meta property="og:site_name" content="Hao Yu&#39;s blog">
<meta property="og:description" content="概述Linux系统在访问设备的时候，存在以下几种IO模型：  Blocking IO Model，阻塞IO模型； Nonblocking I/O Model，非阻塞IO模型； I/O Multiplexing Model，IO多路复用模型; Signal Driven I/O Model，信号驱动IO模型； Asynchronous I/O Model，异步IO模型；  今天我们来分析下IO多路复">
<meta property="og:locale" content="zn-ch">
<meta property="og:image" content="http://yoursite.com/img/20200806180800.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180801.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180802.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180803.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180804.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180805.png">
<meta property="og:image" content="http://yoursite.com/img/20200806180806.png">
<meta property="og:updated_time" content="2020-08-13T09:37:29.631Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux selectpoll机制原理分析">
<meta name="twitter:description" content="概述Linux系统在访问设备的时候，存在以下几种IO模型：  Blocking IO Model，阻塞IO模型； Nonblocking I/O Model，非阻塞IO模型； I/O Multiplexing Model，IO多路复用模型; Signal Driven I/O Model，信号驱动IO模型； Asynchronous I/O Model，异步IO模型；  今天我们来分析下IO多路复">
<meta name="twitter:image" content="http://yoursite.com/img/20200806180800.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/08/06/Linux select poll机制原理分析/">





  <title>Linux selectpoll机制原理分析 | Hao Yu's blog</title>
  








 
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zn-ch">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hao Yu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The program monkey was eaten by the siege lion.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/resume.pdf" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-mybetterhalf">
          <a href="/mybetterhalf/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            mybetterhalf
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/06/Linux select poll机制原理分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Hao Yu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/header.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hao Yu's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux selectpoll机制原理分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-08-06T18:08:00+08:00">
                2020-08-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Linux系统在访问设备的时候，存在以下几种IO模型：</p>
<ul>
<li>Blocking IO Model，阻塞IO模型；</li>
<li>Nonblocking I/O Model，非阻塞IO模型；</li>
<li>I/O Multiplexing Model，IO多路复用模型;</li>
<li>Signal Driven I/O Model，信号驱动IO模型；</li>
<li>Asynchronous I/O Model，异步IO模型；</li>
</ul>
<p>今天我们来分析下IO多路复用机制，在Linux中是通过select/poll/epoll机制来实现的。</p>
<p>先看一下阻塞IO模型与非阻塞IO模型的特点：<br><img src="/img/20200806180800.png" alt></p>
<ul>
<li>阻塞IO模型：在IO访问的时候，如果条件没有满足，会将当前任务切换出去，等到条件满足时再切换回来。<ul>
<li>缺点：阻塞IO操作，会让处于同一个线程的执行逻辑都在阻塞期间无法执行，这往往意味着需要创建单独的线程来交互。</li>
</ul>
</li>
<li>非阻塞IO模型：在IO访问的时候，如果条件没有满足，直接返回，不会block该任务的后续操作。<ul>
<li>缺点：非阻塞IO需要用户一直轮询操作，轮询可能会来带CPU的占用问题。</li>
</ul>
</li>
</ul>
<p>对单个设备IO操作时，问题并不严重，如果有多个设备呢？比如，在服务器中，监听多个Client的收发处理，这时候IO多路复用就显得尤为重要了，来张图：<br><img src="/img/20200806180801.png" alt></p>
<p>如果这个图，让你有点迷惑，那就像个男人一样，man一下select/poll函数吧：</p>
<p>select:<br><img src="/img/20200806180802.png" alt></p>
<p>poll:<br><img src="/img/20200806180803.png" alt></p>
<p>简单来说，select/poll能监听多个设备的文件描述符，只要有任何一个设备满足条件，select/poll就会返回，否则将进行睡眠等待。看起来，select/poll像是一个管家了，统一负责来监听处理了。</p>
<p>已经迫不及待来看看原理了，由于底层的机制大体差不多，我将选择select来做进一步分析。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="select系统调用"><a href="#select系统调用" class="headerlink" title="select系统调用"></a>select系统调用</h2><p>从select的系统调用开始：<br><img src="/img/20200806180804.png" alt></p>
<ul>
<li>select系统调用，最终的核心逻辑是在<code>do_select</code>函数中处理的，参考<code>fs/select.c</code>文件；</li>
<li>do_select函数中，有几个关键的操作：<ul>
<li>初始化<code>poll_wqueues</code>结构，包括几个关键函数指针的初始化，用于驱动中进行回调处理；</li>
<li>循环遍历监测的文件描述符，并且调用<code>f_op-&gt;poll()</code>函数，如果有监测条件满足，则会跳出循环；</li>
<li>在监测的文件描述符都不满足条件时，<code>poll_schedule_timeout</code>让当前进程进行睡眠，超时唤醒，或者被所属的等待队列唤醒；</li>
</ul>
</li>
<li>do_select函数的循环退出条件有三个：<ul>
<li>检测的文件描述符满足条件；</li>
<li>超时；</li>
<li>有信号要处理；</li>
</ul>
</li>
<li>在设备驱动程序中实现的<code>poll()</code>函数，会在<code>do_select()</code>中被调用，而驱动中的<code>poll()</code>函数，需要调用<code>poll_wait()</code>函数，<code>poll_wait</code>函数本身很简单，就是去回调函数<code>p-&gt;_qproc()</code>，这个回调函数正是<code>poll_initwait()</code>函数中初始化的<code>__pollwait()</code>；</li>
</ul>
<h2 id="pollwait"><a href="#pollwait" class="headerlink" title="__pollwait"></a><code>__pollwait</code></h2><p><img src="/img/20200806180805.png" alt></p>
<ul>
<li>驱动中的<code>poll_wait</code>函数回调<code>__pollwait</code>，这个函数完成的工作是向<code>struct poll_wqueue</code>结构中添加一条<code>poll_table_entry</code>；</li>
<li><code>poll_table_entry</code>中包含了等待队列的相关数据结构；</li>
<li>对等待队列的相关数据结构进行初始化，包括设置等待队列唤醒时的回调函数指针，设置成<code>pollwake</code>；</li>
<li>将任务添加到驱动程序中的等待队列中，最终驱动可以通过<code>wake_up_interruptile</code>等接口来唤醒处理；</li>
</ul>
<p>这一顿操作，其实就是驱动向select维护的<code>struct poll_wqueue</code>中注册，并将调用select的任务添加到驱动的等待队列中，以便在合适的时机进行唤醒。所以，本质上来说，这是基于等待队列的机制来实现的。</p>
<p>是不是还有点抽象，来看看数据结构的组织关系吧。</p>
<h2 id="数据结构关系"><a href="#数据结构关系" class="headerlink" title="数据结构关系"></a>数据结构关系</h2><p><img src="/img/20200806180806.png" alt></p>
<p>调用select系统调用的进程/线程，会维护一个<code>struct poll_wqueues</code>结构，其中两个关键字段：</p>
<ul>
<li><code>pll_table</code>：该结构体中的函数指针<code>_qproc</code>指向<code>__pollwait</code>函数；</li>
<li><code>struct poll_table_entry[]</code>：存放不同设备的<code>poll_table_entry</code>，这些条目的增加是在驱动调用<code>poll_wait-&gt;__pollwait()</code>时进行初始化并完成添加的；</li>
</ul>
<h2 id="驱动编写启示"><a href="#驱动编写启示" class="headerlink" title="驱动编写启示"></a>驱动编写启示</h2><p>如果驱动中要支持select的接口调用，那么需要做哪些事情呢？如果理解了上文中的内容，你会毫不犹豫的大声说出以下几条：</p>
<ol>
<li>定义一个等待队列头<code>wait_queue_head_t</code>，用于收留等待队列任务；</li>
<li><code>struct file_operations</code>结构体中的poll函数需要实现，比如<code>xxx_poll()</code>；</li>
<li><code>xxx_poll()</code>函数中，当然不要忘了<code>poll_wait</code>函数的调用了，此外，该函数的返回值mask需要注意是在条件满足时对应的值，比如EPOLLIN/EPOLL/EPOLLERR等，这个返回值是在<code>do_select()</code>函数中会去判断处理的；</li>
<li>条件满足的时候，<code>wake_up_interruptible</code>唤醒任务，当然也可以使用<code>wake_up</code>，区别是：<code>wake_up_interruptible</code>只能唤醒处于<code>TASK_INTERRUPTIBLE</code>状态的任务，而<code>wake_up</code>能唤醒处于<code>TASK_INTERRUPTIBLE</code>和<code>TASK_UNINTERRUPTIBLE</code>状态的任务；</li>
</ol>
<h2 id="select-poll的差异"><a href="#select-poll的差异" class="headerlink" title="select/poll的差异"></a>select/poll的差异</h2><ul>
<li>select与poll本质上基本类似，其中select是由BSD UNIX引入，poll由SystemV引入；</li>
<li>select与poll需要轮询文件描述符集合，并在用户态和内核态之间进行拷贝，在文件描述符很多的情况下开销会比较大，select默认支持的文件描述符数量是1024；</li>
<li>Linux提供了epoll机制，改进了select与poll在效率与资源上的缺点，未深入了解；</li>
</ul>
<h1 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h1><h2 id="内核驱动"><a href="#内核驱动" class="headerlink" title="内核驱动"></a>内核驱动</h2><p>示例代码中的逻辑：</p>
<ul>
<li>驱动维护一个count值，当count值大于0时，表明条件满足，poll返回正常的mask值；</li>
<li>poll函数每执行一次，count值就减去一次；</li>
<li>count的值可以由用户通过ioctl来进行设置；</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLL_DEV_NAME		<span class="meta-string">"poll"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLL_MAGIC		<span class="meta-string">'P'</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLL_SET_COUNT      (_IOW(POLL_MAGIC, 0, unsigned int))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_dev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">class</span> *<span class="title">class</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> wq_head;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">poll_mutex</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">dev_t</span> devno;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">poll_dev</span> *<span class="title">g_poll_dev</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">poll_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	filp-&gt;private_data = g_poll_dev;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">poll_close</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">poll_poll</span><span class="params">(struct file *filp, struct poll_table_struct *wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mask = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">poll_dev</span> *<span class="title">dev</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;dev-&gt;poll_mutex);</span><br><span class="line"></span><br><span class="line">	poll_wait(filp, &amp;dev-&gt;wq_head, wait);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (dev-&gt;count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		mask |= POLLIN | POLLRDNORM;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* decrease each time */</span></span><br><span class="line">		dev-&gt;count--;</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;dev-&gt;poll_mutex);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">poll_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">poll_dev</span> *<span class="title">dev</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> cnt;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> POLL_SET_COUNT:</span><br><span class="line">			mutex_lock(&amp;dev-&gt;poll_mutex);</span><br><span class="line">			<span class="keyword">if</span> (copy_from_user(&amp;cnt, (<span class="keyword">void</span> __user *)arg, _IOC_SIZE(cmd))) &#123;</span><br><span class="line">				pr_err(<span class="string">"copy_from_user fail:%d\n"</span>, __LINE__);</span><br><span class="line">				<span class="keyword">return</span> -EFAULT;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (dev-&gt;count == <span class="number">0</span>) &#123;</span><br><span class="line">				wake_up_interruptible(&amp;dev-&gt;wq_head);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* update count */</span></span><br><span class="line">			dev-&gt;count += cnt;</span><br><span class="line"></span><br><span class="line">			mutex_unlock(&amp;dev-&gt;poll_mutex);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">poll_fops</span> = &#123;</span></span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = poll_open,</span><br><span class="line">	.release = poll_close,</span><br><span class="line">	.poll = poll_poll,</span><br><span class="line">	.unlocked_ioctl = poll_ioctl,</span><br><span class="line">	.compat_ioctl = poll_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">poll_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (g_poll_dev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		g_poll_dev = (struct poll_dev *)kzalloc(<span class="keyword">sizeof</span>(struct poll_dev), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (g_poll_dev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pr_err(<span class="string">"struct poll_dev allocate fail\n"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* allocate device number */</span></span><br><span class="line">	ret = alloc_chrdev_region(&amp;g_poll_dev-&gt;devno, <span class="number">0</span>, <span class="number">1</span>, POLL_DEV_NAME);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">"alloc_chrdev_region fail:%d\n"</span>, ret);</span><br><span class="line">		<span class="keyword">goto</span> alloc_chrdev_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set char-device */</span></span><br><span class="line">	cdev_init(&amp;g_poll_dev-&gt;cdev, &amp;poll_fops);</span><br><span class="line">	g_poll_dev-&gt;cdev.owner = THIS_MODULE;</span><br><span class="line">	ret = cdev_add(&amp;g_poll_dev-&gt;cdev, g_poll_dev-&gt;devno, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		pr_err(<span class="string">"cdev_add fail:%d\n"</span>, ret);</span><br><span class="line">		<span class="keyword">goto</span> cdev_add_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* create device */</span></span><br><span class="line">	g_poll_dev-&gt;<span class="class"><span class="keyword">class</span> = <span class="title">class_create</span>(<span class="title">THIS_MODULE</span>, <span class="title">POLL_DEV_NAME</span>);</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(g_poll_dev-&gt;class)) &#123;</span><br><span class="line">		pr_err(<span class="string">"class_create fail\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> class_create_err;</span><br><span class="line">	&#125;</span><br><span class="line">	g_poll_dev-&gt;device = device_create(g_poll_dev-&gt;class, <span class="literal">NULL</span>,</span><br><span class="line">			g_poll_dev-&gt;devno, <span class="literal">NULL</span>, POLL_DEV_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(g_poll_dev-&gt;device)) &#123;</span><br><span class="line">		pr_err(<span class="string">"device_create fail\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> device_create_err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	mutex_init(&amp;g_poll_dev-&gt;poll_mutex);</span><br><span class="line">	init_waitqueue_head(&amp;g_poll_dev-&gt;wq_head);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">device_create_err:</span><br><span class="line">	class_destroy(g_poll_dev-&gt;class);</span><br><span class="line">class_create_err:</span><br><span class="line">	cdev_del(&amp;g_poll_dev-&gt;cdev);</span><br><span class="line">cdev_add_err:</span><br><span class="line">	unregister_chrdev_region(g_poll_dev-&gt;devno, <span class="number">1</span>);</span><br><span class="line">alloc_chrdev_err:</span><br><span class="line">	kfree(g_poll_dev);</span><br><span class="line">	g_poll_dev = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">poll_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	cdev_del(&amp;g_poll_dev-&gt;cdev);</span><br><span class="line">	device_destroy(g_poll_dev-&gt;class, g_poll_dev-&gt;devno);</span><br><span class="line">	unregister_chrdev_region(g_poll_dev-&gt;devno, <span class="number">1</span>);</span><br><span class="line">	class_destroy(g_poll_dev-&gt;class);</span><br><span class="line"></span><br><span class="line">	kfree(g_poll_dev);</span><br><span class="line">	g_poll_dev = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(poll_init);</span><br><span class="line">module_exit(poll_exit);</span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">"select/poll test"</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">"LoyenWang"</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</span><br></pre></td></tr></table></figure>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>测试代码逻辑：</p>
<ul>
<li>创建一个设值线程，用于每隔2秒来设置一次count值；</li>
<li>主线程调用select函数监听，当设值线程设置了count值后，select便会返回；</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">set_count_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd = *(<span class="keyword">int</span> *)arg;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count_value = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> loop_cnt = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (loop_cnt--) &#123;</span><br><span class="line">		ret = ioctl(fd, NOTIFY_SET_COUNT, &amp;count_value);</span><br><span class="line">		<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"ioctl set count value fail:%s\n"</span>, strerror(errno));</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line">	<span class="keyword">pthread_t</span> setcnt_tid;</span><br><span class="line">	<span class="keyword">int</span> loop_cnt = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* for select use */</span></span><br><span class="line">	fd_set rfds;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line"></span><br><span class="line">	fd = open(<span class="string">"/dev/poll"</span>, O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"/dev/poll open failed: %s\n"</span>, strerror(errno));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* wait up to five seconds */</span></span><br><span class="line">	tv.tv_sec = <span class="number">5</span>;</span><br><span class="line">	tv.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ret = pthread_create(&amp;setcnt_tid, <span class="literal">NULL</span>,</span><br><span class="line">			set_count_thread, &amp;fd);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"set_count_thread create fail: %d\n"</span>, ret);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (loop_cnt--) &#123;</span><br><span class="line">		FD_ZERO(&amp;rfds);</span><br><span class="line">		FD_SET(fd, &amp;rfds);</span><br><span class="line"></span><br><span class="line">		ret = select(fd + <span class="number">1</span>, &amp;rfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;tv);</span><br><span class="line">		<span class="comment">//ret = select(fd + 1, &amp;rfds, NULL, NULL, NULL);</span></span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">			perror(<span class="string">"select()"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (ret)</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"Data is available now.\n"</span>);</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">"No data within five seconds.\n"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = pthread_join(setcnt_tid, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"set_count_thread join fail.\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/06/grep_sed_awk/" rel="next" title="grep、sed、awk高效文件处理3剑客">
                <i class="fa fa-chevron-left"></i> grep、sed、awk高效文件处理3剑客
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/11/操作系统真相还原 笔记6/" rel="prev" title="操作系统真相还原14-15章">
                操作系统真相还原14-15章 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/header.jpg" alt="Hao Yu">
            
              <p class="site-author-name" itemprop="name">Hao Yu</p>
              <p class="site-description motion-element" itemprop="description">Introduce something interesting and recode learning process, some articles are written by others, the original link has been given as much as possible, thanks to the original author</p>
          </div>
          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">273</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>
        	<audio controls="controls" loop="loop" preload="auto" src="/resource/xiaomeihao.mp3">
	        </audio>
	

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yuhao0102" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yuh18@mails.tsinghua.edu.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原理"><span class="nav-number">2.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#select系统调用"><span class="nav-number">2.1.</span> <span class="nav-text">select系统调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pollwait"><span class="nav-number">2.2.</span> <span class="nav-text">__pollwait</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据结构关系"><span class="nav-number">2.3.</span> <span class="nav-text">数据结构关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#驱动编写启示"><span class="nav-number">2.4.</span> <span class="nav-text">驱动编写启示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-poll的差异"><span class="nav-number">2.5.</span> <span class="nav-text">select/poll的差异</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#示例代码"><span class="nav-number">3.</span> <span class="nav-text">示例代码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#内核驱动"><span class="nav-number">3.1.</span> <span class="nav-text">内核驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试代码"><span class="nav-number">3.2.</span> <span class="nav-text">测试代码</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>
  <div id="DvelopmentTarget">     
  </div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart" aria-hidden="false"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Hao Yu</span>

  
</div>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_uv"> 
  本站访客数<span id="busuanzi_value_site_uv"></span>人次
</span>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  


  

  


  <script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
